<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen3-TTS Studio - ä¸“ä¸šè¯­éŸ³åˆæˆå·¥ä½œå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        body { background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }
        
        /* Header */
        .header { background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%); border-bottom: 1px solid #333; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .logo-text h1 { font-size: 20px; font-weight: 600; color: #fff; }
        .logo-text p { font-size: 12px; color: #888; }
        .header-actions { display: flex; gap: 10px; }
        .header-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #e0e0e0; font-size: 13px; cursor: pointer; transition: all 0.3s; }
        .header-btn:hover { background: rgba(102,126,234,0.3); border-color: #667eea; }
        
        /* Main Layout */
        .main-container { display: flex; height: calc(100vh - 72px); }
        
        /* Left Panel - Input */
        .left-panel { width: 400px; background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .panel-tabs { display: flex; border-bottom: 1px solid #333; }
        .panel-tab { flex: 1; padding: 15px; text-align: center; font-size: 13px; color: #888; cursor: pointer; transition: all 0.3s; border-bottom: 2px solid transparent; }
        .panel-tab:hover { color: #e0e0e0; background: rgba(255,255,255,0.05); }
        .panel-tab.active { color: #667eea; border-bottom-color: #667eea; background: rgba(102,126,234,0.1); }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; color: #aaa; margin-bottom: 8px; font-weight: 500; }
        .form-label .hint { font-size: 11px; color: #666; font-weight: normal; margin-left: 5px; }
        textarea, input[type="text"], select { width: 100%; padding: 12px; background: #252525; border: 1px solid #333; border-radius: 8px; color: #e0e0e0; font-size: 14px; transition: all 0.3s; }
        textarea { min-height: 120px; resize: vertical; font-family: inherit; line-height: 1.6; }
        textarea:focus, input[type="text"]:focus, select:focus { outline: none; border-color: #667eea; background: #2a2a2a; }
        select option { background: #252525; }
        
        /* Quick Actions */
        .quick-actions { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .quick-btn { padding: 6px 12px; background: #333; border: 1px solid #444; border-radius: 16px; color: #aaa; font-size: 12px; cursor: pointer; transition: all 0.3s; }
        .quick-btn:hover { background: #667eea; border-color: #667eea; color: #fff; }
        
        /* Generate Button */
        .generate-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 20px; }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .generate-btn.generating { background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%); }
        
        /* Center Panel - Preview */
        .center-panel { flex: 1; background: #141414; display: flex; flex-direction: column; }
        .preview-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .preview-title { font-size: 16px; font-weight: 600; }
        .preview-actions { display: flex; gap: 10px; }
        .preview-btn { padding: 8px 16px; background: #333; border: 1px solid #444; border-radius: 6px; color: #e0e0e0; font-size: 12px; cursor: pointer; transition: all 0.3s; }
        .preview-btn:hover { background: #444; }
        
        /* Audio Visualizer */
        .visualizer-container { padding: 40px; display: flex; align-items: center; justify-content: center; }
        .visualizer { display: flex; align-items: center; gap: 4px; height: 150px; }
        .visualizer-bar { width: 6px; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); border-radius: 3px; transition: height 0.1s ease; }
        .visualizer-bar.active { animation: bounce 0.5s ease-in-out infinite alternate; }
        @keyframes bounce { from { height: 20%; } to { height: 80%; } }
        
        /* Audio Player */
        .player-container { padding: 0 40px 40px; }
        .player-card { background: linear-gradient(135deg, #1a1a2e 0%, #252525 100%); border-radius: 16px; padding: 30px; border: 1px solid #333; }
        .player-controls { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .play-btn { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        .play-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(102,126,234,0.5); }
        .play-btn svg { width: 24px; height: 24px; fill: #fff; }
        .progress-container { flex: 1; }
        .progress-bar-bg { height: 6px; background: #333; border-radius: 3px; cursor: pointer; position: relative; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 3px; width: 0%; transition: width 0.1s; position: relative; }
        .progress-bar-fill::after { content: ''; position: absolute; right: -8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; background: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .time-display { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-top: 8px; }
        .player-actions { display: flex; gap: 12px; }
        .player-action-btn { padding: 10px 20px; background: #333; border: 1px solid #444; border-radius: 8px; color: #e0e0e0; font-size: 13px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .player-action-btn:hover { background: #444; border-color: #667eea; }
        
        /* Right Panel - Settings & History */
        .right-panel { width: 350px; background: #1a1a1a; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .right-tabs { display: flex; border-bottom: 1px solid #333; }
        .right-tab { flex: 1; padding: 15px; text-align: center; font-size: 13px; color: #888; cursor: pointer; transition: all 0.3s; }
        .right-tab:hover { color: #e0e0e0; background: rgba(255,255,255,0.05); }
        .right-tab.active { color: #667eea; background: rgba(102,126,234,0.1); }
        .right-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Settings */
        .setting-group { margin-bottom: 25px; }
        .setting-title { font-size: 12px; color: #667eea; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .setting-item { margin-bottom: 15px; }
        .setting-label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .setting-slider { width: 100%; height: 6px; background: #333; border-radius: 3px; -webkit-appearance: none; appearance: none; }
        .setting-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #667eea; border-radius: 50%; cursor: pointer; }
        .setting-value { display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 5px; }
        
        /* Custom Select Dropdown - Fixed */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            display: block;
        }
        .custom-select-wrapper::after {
            content: 'â–¼';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 10px;
            pointer-events: none;
            z-index: 1;
        }
        select.custom-select {
            display: block !important;
            width: 100% !important;
            height: 44px !important;
            min-height: 44px !important;
            padding: 10px 35px 10px 15px !important;
            background: #252525 !important;
            border: 1px solid #333 !important;
            border-radius: 6px !important;
            color: #e0e0e0 !important;
            font-size: 14px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif !important;
            line-height: 1.6 !important;
            cursor: pointer !important;
            outline: none !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            box-sizing: border-box !important;
            overflow: visible !important;
        }
        select.custom-select:focus {
            border-color: #667eea !important;
        }
        select.custom-select option {
            background: #252525 !important;
            color: #e0e0e0 !important;
            padding: 10px !important;
            font-size: 14px !important;
        }
        
        /* History */
        .history-list { margin-top: 10px; }
        .history-item { background: #252525; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; border: 1px solid transparent; }
        .history-item:hover { background: #2a2a2a; border-color: #667eea; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .history-mode { font-size: 12px; font-weight: 600; color: #667eea; }
        .history-time { font-size: 11px; color: #666; }
        .history-text { font-size: 12px; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-meta { display: flex; gap: 10px; margin-top: 6px; font-size: 11px; color: #666; }
        
        /* Status Bar */
        .status-bar { padding: 12px 20px; background: #0f0f0f; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .status-text { font-size: 12px; color: #888; display: flex; align-items: center; gap: 8px; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #52c41a; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-indicator.processing { background: #faad14; }
        .status-indicator.error { background: #ff4d4f; }
        .generation-info { font-size: 12px; color: #667eea; }
        
        /* Toast */
        .toast { position: fixed; bottom: 30px; right: 30px; background: #252525; border: 1px solid #444; border-radius: 8px; padding: 16px 20px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: translateX(400px); transition: transform 0.3s; z-index: 1000; }
        .toast.show { transform: translateX(0); }
        .toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .toast-icon.success { background: rgba(82,196,26,0.2); color: #52c41a; }
        .toast-icon.error { background: rgba(255,77,79,0.2); color: #ff4d4f; }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 999; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid #333; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: #888; font-size: 14px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ™ï¸</div>
            <div class="logo-text">
                <h1>Qwen3-TTS Studio</h1>
                <p>ä¸“ä¸šè¯­éŸ³åˆæˆå·¥ä½œå°</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
            <button class="header-btn" onclick="exportAudio()">ğŸ’¾ å¯¼å‡ºéŸ³é¢‘</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Input -->
        <div class="left-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchTab('voice-design')">ğŸ¨ å£°éŸ³è®¾è®¡</div>
                <div class="panel-tab" onclick="switchTab('voice-clone')">ğŸ­ å£°éŸ³å…‹éš†</div>
                <div class="panel-tab" onclick="switchTab('tts-custom')">ğŸ”Š é¢„è®¾å£°éŸ³</div>
            </div>
            
            <div class="panel-content">
                <!-- Voice Design Tab -->
                <div id="tab-voice-design" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©æ¨¡å‹ <span class="hint">ä¸åŒç‰ˆæœ¬å½±å“ç”Ÿæˆè´¨é‡å’Œé€Ÿåº¦</span></label>
                        <select id="vd-model" onchange="updateModelInfo('voice-design')">
                            <option value="1.7b">1.7B-Full (å®Œæ•´ç‰ˆï¼Œè´¨é‡æœ€ä½³)</option>
                            <option value="0.6b">0.6B (è½»é‡ç‰ˆï¼Œé€Ÿåº¦æå‡3å€)</option>
                            <option value="fast">âš¡ æé€Ÿæ¨¡å¼ (æœ€å¿«ç”Ÿæˆï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆ)</option>
                        </select>
                        <div id="vd-model-info" style="margin-top: 8px; font-size: 11px; color: #888;">
                            å®Œæ•´ç‰ˆï¼šæœ€é«˜è´¨é‡ï¼Œé€‚åˆå¯¹éŸ³è´¨è¦æ±‚é«˜çš„åœºæ™¯
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ–‡æœ¬å†…å®¹ <span class="hint">æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ç­‰å¤šç§è¯­è¨€</span></label>
                        <textarea id="vd-text" placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬...">å®ƒåœ¨æœ€ä¸Šé¢çš„æŠ½å±‰é‡Œâ€¦â€¦ç­‰ç­‰ï¼ŒæŠ½å±‰æ˜¯ç©ºçš„ï¼Ÿä¸å¯èƒ½ï¼Œè¿™ç»å¯¹ä¸å¯èƒ½ï¼</textarea>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="insertText('vd-text', 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ã€‚')">æµ‹è¯•æ–‡æœ¬</button>
                        <button class="quick-btn" onclick="insertText('vd-text', 'Hello, this is a test.')">English</button>
                        <button class="quick-btn" onclick="clearText('vd-text')">æ¸…ç©º</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¯­è¨€</label>
                        <select id="vd-language">
                            <option value="chinese">ä¸­æ–‡</option>
                            <option value="english">English</option>
                            <option value="japanese">æ—¥æœ¬èª</option>
                            <option value="korean">í•œêµ­ì–´</option>
                            <option value="french">FranÃ§ais</option>
                            <option value="german">Deutsch</option>
                            <option value="spanish">EspaÃ±ol</option>
                            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å£°éŸ³æè¿° <span class="hint">æè¿°ä½ æƒ³è¦çš„å£°éŸ³ç‰¹å¾ã€æƒ…æ„Ÿã€è¯­é€Ÿç­‰</span></label>
                        <textarea id="vd-description" placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”çš„å¥³å£°ï¼Œè¯­é€Ÿé€‚ä¸­ï¼Œå¸¦æœ‰å…³æ€€çš„è¯­æ°”...">ç”¨éš¾ä»¥ç½®ä¿¡çš„è¯­æ°”è¯´è¯ï¼Œä½†è¯­æ°”ä¸­å¼€å§‹æµéœ²å‡ºä¸€ä¸ææ…Œã€‚è¯´è¯èŠ‚å¥æ€¥ä¿ƒï¼Œå£°éŸ³ç•¥å¾®é¢¤æŠ–ã€‚</textarea>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="setDescription('æ¸©æŸ”çš„å¥³å£°ï¼Œè¯­é€Ÿé€‚ä¸­')">æ¸©æŸ”</button>
                        <button class="quick-btn" onclick="setDescription('æˆç†Ÿç”·å£°ï¼Œæ²‰ç¨³æœ‰åŠ›')">æ²‰ç¨³</button>
                        <button class="quick-btn" onclick="setDescription('æ´»æ³¼æ¬¢å¿«çš„å£°éŸ³')">æ´»æ³¼</button>
                        <button class="quick-btn" onclick="setDescription('æ‚²ä¼¤ä½æ²‰çš„å£°éŸ³')">æ‚²ä¼¤</button>
                    </div>
                    
                    <button class="generate-btn" id="vd-generate" onclick="generateVoiceDesign()">
                        <span>ğŸ¨</span> ç”Ÿæˆå£°éŸ³
                    </button>
                </div>
                
                <!-- Voice Clone Tab -->
                <div id="tab-voice-clone" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©æ¨¡å‹ <span class="hint">ä¸åŒç‰ˆæœ¬å½±å“å…‹éš†è´¨é‡å’Œé€Ÿåº¦</span></label>
                        <select id="vc-model" onchange="updateModelInfo('voice-clone')">
                            <option value="1.7b">1.7B-Full (å®Œæ•´ç‰ˆï¼Œå…‹éš†è´¨é‡æœ€ä½³)</option>
                            <option value="0.6b">0.6B (è½»é‡ç‰ˆï¼Œé€Ÿåº¦æå‡3å€)</option>
                            <option value="fast">âš¡ æé€Ÿæ¨¡å¼ (æœ€å¿«ç”Ÿæˆï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆ)</option>
                        </select>
                        <div id="vc-model-info" style="margin-top: 8px; font-size: 11px; color: #888;">
                            å®Œæ•´ç‰ˆï¼šæœ€ä½³å…‹éš†æ•ˆæœï¼Œä¿ç•™æ›´å¤šå£°éŸ³ç»†èŠ‚
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å‚è€ƒéŸ³é¢‘ <span class="hint">ä¸Šä¼ 10-30ç§’çš„æ¸…æ™°éŸ³é¢‘æ ·æœ¬</span></label>
                        <div style="border: 2px dashed #444; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s;" ondragover="event.preventDefault()" ondrop="handleDrop(event)" onclick="document.getElementById('vc-audio').click()" id="upload-area">
                            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“</div>
                            <div style="font-size: 13px; color: #888;">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">æ”¯æŒ WAV, MP3, OGG æ ¼å¼</div>
                            <input type="file" id="vc-audio" accept="audio/*" style="display: none;" onchange="handleAudioUpload(event)">
                        </div>
                        
                        <!-- éŸ³é¢‘æ’­æ”¾å™¨åŒºåŸŸ -->
                        <div id="ref-audio-player" style="display: none; margin-top: 15px; background: #252525; border-radius: 8px; padding: 15px; border: 1px solid #333;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <!-- æ’­æ”¾æŒ‰é’® - ä½¿ç”¨å›ºå®šå°ºå¯¸ç¡®ä¿ä¸å˜å½¢ -->
                                <div onclick="toggleRefAudioPlay()" id="ref-play-btn" style="width: 44px; height: 44px; min-width: 44px; min-height: 44px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer; position: relative; flex-shrink: 0; flex-grow: 0;">
                                    <!-- æ’­æ”¾å›¾æ ‡ -->
                                    <div id="ref-play-icon" style="position: absolute; top: 50%; left: 55%; transform: translate(-50%, -50%); width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 14px solid white;"></div>
                                    <!-- æš‚åœå›¾æ ‡ -->
                                    <div id="ref-pause-icon" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                                        <div style="display: flex; gap: 3px;">
                                            <div style="width: 4px; height: 14px; background: white;"></div>
                                            <div style="width: 4px; height: 14px; background: white;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1; overflow: hidden;">
                                    <div style="font-size: 12px; color: #888; margin-bottom: 4px;">å‚è€ƒéŸ³é¢‘é¢„è§ˆ</div>
                                    <div id="ref-filename-display" style="font-size: 13px; color: #e0e0e0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                                </div>
                                <button onclick="removeRefAudio()" style="padding: 6px 12px; background: #333; border: 1px solid #444; border-radius: 4px; color: #888; font-size: 11px; cursor: pointer; white-space: nowrap; flex-shrink: 0;">ç§»é™¤</button>
                            </div>
                            
                            <!-- è¿›åº¦æ¡ -->
                            <div style="margin-bottom: 8px;">
                                <div style="height: 4px; background: #333; border-radius: 2px; cursor: pointer; position: relative;" onclick="seekRefAudio(event)">
                                    <div id="ref-progress-bar" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; position: relative;">
                                        <div style="position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ—¶é—´æ˜¾ç¤º -->
                            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666;">
                                <span id="ref-current-time">0:00</span>
                                <span id="ref-total-time">0:00</span>
                            </div>
                            
                            <!-- éŸ³é¢‘ä¿¡æ¯ -->
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; gap: 15px; font-size: 11px; color: #888;">
                                <span id="ref-audio-duration">â±ï¸ æ—¶é•¿: --</span>
                                <span id="ref-audio-size">ğŸ“¦ å¤§å°: --</span>
                                <span id="ref-audio-format">ğŸµ æ ¼å¼: --</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å‚è€ƒæ–‡æœ¬ <span class="hint">å¯é€‰ï¼Œè¾“å…¥å‚è€ƒéŸ³é¢‘çš„æ–‡æœ¬å†…å®¹å¯æé«˜å…‹éš†è´¨é‡</span></label>
                        <textarea id="vc-reference-text" placeholder="è¾“å…¥å‚è€ƒéŸ³é¢‘çš„æ–‡æœ¬å†…å®¹..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç›®æ ‡æ–‡æœ¬</label>
                        <textarea id="vc-target-text" placeholder="è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¯­è¨€</label>
                        <select id="vc-language">
                            <option value="chinese">ä¸­æ–‡</option>
                            <option value="english">English</option>
                            <option value="japanese">æ—¥æœ¬èª</option>
                            <option value="korean">í•œêµ­ì–´</option>
                            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        </select>
                    </div>
                    
                    <button class="generate-btn" id="vc-generate" onclick="generateVoiceClone()">
                        <span>ğŸ­</span> å…‹éš†å£°éŸ³
                    </button>
                </div>
                
                <!-- TTS Custom Tab -->
                <div id="tab-tts-custom" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©æ¨¡å‹ <span class="hint">ä¸åŒç‰ˆæœ¬å½±å“åˆæˆè´¨é‡å’Œé€Ÿåº¦</span></label>
                        <select id="tc-model" onchange="updateModelInfo('tts-custom')">
                            <option value="1.7b">1.7B-Full (å®Œæ•´ç‰ˆï¼Œè´¨é‡æœ€ä½³)</option>
                            <option value="0.6b">0.6B (è½»é‡ç‰ˆï¼Œé€Ÿåº¦æå‡3å€)</option>
                            <option value="fast">âš¡ æé€Ÿæ¨¡å¼ (æœ€å¿«ç”Ÿæˆï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆ)</option>
                        </select>
                        <div id="tc-model-info" style="margin-top: 8px; font-size: 11px; color: #888;">
                            å®Œæ•´ç‰ˆï¼šæœ€é«˜è´¨é‡è¯­éŸ³åˆæˆï¼Œé€‚åˆä¸“ä¸šåœºæ™¯
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ–‡æœ¬å†…å®¹</label>
                        <textarea id="tc-text" placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©å£°éŸ³</label>
                        <select id="tc-speaker">
                            <option value="Vivian">Vivian - æ¸©æŸ”å¥³å£°</option>
                            <option value="Mike">Mike - æˆç†Ÿç”·å£°</option>
                            <option value="Lisa">Lisa - æ´»æ³¼å¥³å£°</option>
                            <option value="David">David - æ²‰ç¨³ç”·å£°</option>
                            <option value="Emma">Emma - ç”œç¾å¥³å£°</option>
                            <option value="John">John - ç£æ€§ç”·å£°</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¯­è¨€</label>
                        <select id="tc-language">
                            <option value="chinese">ä¸­æ–‡</option>
                            <option value="english">English</option>
                            <option value="japanese">æ—¥æœ¬èª</option>
                            <option value="korean">í•œêµ­ì–´</option>
                            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¯­é€Ÿè°ƒèŠ‚</label>
                        <input type="range" class="setting-slider" id="tc-speed" min="0.5" max="2" step="0.1" value="1">
                        <div class="setting-value">
                            <span>æ…¢</span>
                            <span id="tc-speed-value">1.0x</span>
                            <span>å¿«</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æƒ…æ„Ÿé£æ ¼ <span class="hint">å¯é€‰ï¼Œå¦‚ï¼šæ„‰å¿«ã€æ‚²ä¼¤ã€å…´å¥‹</span></label>
                        <input type="text" id="tc-style" placeholder="ä¾‹å¦‚ï¼šæ„‰å¿«">
                    </div>
                    
                    <button class="generate-btn" id="tc-generate" onclick="generateTTSCustom()">
                        <span>ğŸ”Š</span> ç”Ÿæˆè¯­éŸ³
                    </button>
                </div>
            </div>
        </div>

        <!-- Center Panel - Preview -->
        <div class="center-panel">
            <div class="preview-header">
                <div class="preview-title">ğŸµ éŸ³é¢‘é¢„è§ˆ</div>
                <div class="preview-actions">
                    <button class="preview-btn" onclick="downloadAudio()">â¬‡ï¸ ä¸‹è½½</button>
                    <button class="preview-btn" onclick="shareAudio()">ğŸ”— åˆ†äº«</button>
                </div>
            </div>
            
            <div class="visualizer-container">
                <div class="visualizer" id="visualizer">
                    <!-- Bars will be generated by JS -->
                </div>
            </div>
            
            <div class="player-container">
                <div class="player-card">
                    <div class="player-controls">
                        <button class="play-btn" onclick="togglePlay()" id="play-btn">
                            <svg viewBox="0 0 24 24" id="play-icon"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            <svg viewBox="0 0 24 24" id="pause-icon" style="display: none;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                        </button>
                        <div class="progress-container">
                            <div class="progress-bar-bg" onclick="seekAudio(event)">
                                <div class="progress-bar-fill" id="progress-bar"></div>
                            </div>
                            <div class="time-display">
                                <span id="current-time">0:00</span>
                                <span id="total-time">0:00</span>
                            </div>
                        </div>
                    </div>
                    <div class="player-actions">
                        <button class="player-action-btn" onclick="toggleMute()">
                            <span id="mute-icon">ğŸ”Š</span>
                            <span id="mute-text">éŸ³é‡</span>
                        </button>
                        <button class="player-action-btn" onclick="setPlaybackSpeed()">âš¡ é€Ÿåº¦</button>
                        <button class="player-action-btn" onclick="loopAudio()">ğŸ” å¾ªç¯</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Settings & History -->
        <div class="right-panel">
            <div class="right-tabs">
                <div class="right-tab active" onclick="switchRightTab('settings')">âš™ï¸ å‚æ•°è®¾ç½®</div>
                <div class="right-tab" onclick="switchRightTab('history')">ğŸ“š å†å²è®°å½•</div>
            </div>
            
            <div class="right-content" id="right-settings">
                <div class="setting-group">
                    <div class="setting-title">æ¨¡å‹å‚æ•°</div>
                    <div class="setting-item">
                        <label class="setting-label">Temperature (åˆ›é€ æ€§)</label>
                        <input type="range" class="setting-slider" id="temperature" min="0" max="1" step="0.1" value="0.6">
                        <div class="setting-value">
                            <span>ä¿å®ˆ</span>
                            <span id="temperature-value">0.6</span>
                            <span>åˆ›é€ æ€§</span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Top P (å¤šæ ·æ€§)</label>
                        <input type="range" class="setting-slider" id="top-p" min="0" max="1" step="0.05" value="0.8">
                        <div class="setting-value">
                            <span>ä½</span>
                            <span id="top-p-value">0.8</span>
                            <span>é«˜</span>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-title">éŸ³é¢‘å‚æ•°</div>
                    <div class="setting-item">
                        <label class="setting-label">é‡‡æ ·ç‡</label>
                        <select id="sample-rate" style="display: block; width: 100%; height: 44px; padding: 10px 15px; margin: 0; background: #333; border: 2px solid #555; border-radius: 8px; color: #ffffff; font-size: 15px; font-family: inherit; line-height: 1.5; -webkit-text-fill-color: #ffffff;">
                            <option value="24000">24kHz (é»˜è®¤)</option>
                            <option value="48000">48kHz (é«˜è´¨é‡)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">è¾“å‡ºæ ¼å¼</label>
                        <select id="output-format" style="display: block; width: 100%; height: 44px; padding: 10px 15px; margin: 0; background: #333; border: 2px solid #555; border-radius: 8px; color: #ffffff; font-size: 15px; font-family: inherit; line-height: 1.5; -webkit-text-fill-color: #ffffff;">
                            <option value="wav">WAV (æ— æŸ)</option>
                            <option value="mp3">MP3 (å‹ç¼©)</option>
                            <option value="ogg">OGG (å¼€æº)</option>
                        </select>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-title">æ€§èƒ½ä¼˜åŒ–</div>
                    <div class="setting-item">
                        <label class="setting-label" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="fast-mode" checked style="width: auto;">
                            å¿«é€Ÿæ¨¡å¼ (é™ä½è´¨é‡æ¢å–é€Ÿåº¦)
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="right-content" id="right-history" style="display: none;">
                <div class="history-list" id="history-list">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“­</div>
                        <div style="font-size: 13px;">æš‚æ— å†å²è®°å½•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-text">
            <span class="status-indicator" id="status-indicator"></span>
            <span id="status-text">å°±ç»ª - ç­‰å¾…è¾“å…¥</span>
        </div>
        <div class="generation-info" id="generation-info"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-icon success">âœ“</div>
        <div>
            <div style="font-size: 13px; font-weight: 600;" id="toast-title">æˆåŠŸ</div>
            <div style="font-size: 11px; color: #888;" id="toast-message">æ“ä½œå®Œæˆ</div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">æ­£åœ¨ç”Ÿæˆè¯­éŸ³...</div>
        </div>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="audio-player" ontimeupdate="updateProgress()" onloadedmetadata="updateAudioInfo()"></audio>

    <script>
        // Global State
        let isPlaying = false;
        let isMuted = false;
        let currentAudioUrl = null;
        let historyItems = [];
        let uploadedAudioFile = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initVisualizer();
            loadSettings();
        });

        // Visualizer
        function initVisualizer() {
            const visualizer = document.getElementById('visualizer');
            visualizer.innerHTML = '';
            for (let i = 0; i < 40; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = Math.random() * 30 + 10 + '%';
                visualizer.appendChild(bar);
            }
        }

        function animateVisualizer(active) {
            const bars = document.querySelectorAll('.visualizer-bar');
            bars.forEach((bar, i) => {
                if (active) {
                    bar.classList.add('active');
                    bar.style.animationDelay = i * 0.02 + 's';
                } else {
                    bar.classList.remove('active');
                    bar.style.height = Math.random() * 30 + 10 + '%';
                }
            });
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById('tab-' + tab).style.display = 'block';
        }

        function switchRightTab(tab) {
            document.querySelectorAll('.right-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('right-settings').style.display = tab === 'settings' ? 'block' : 'none';
            document.getElementById('right-history').style.display = tab === 'history' ? 'block' : 'none';
        }

        // Quick Actions
        function insertText(id, text) {
            document.getElementById(id).value = text;
        }

        function clearText(id) {
            document.getElementById(id).value = '';
        }

        function setDescription(text) {
            document.getElementById('vd-description').value = text;
        }

        // Reference Audio Player
        let refAudioPlayer = null;
        let isRefAudioPlaying = false;

        // Audio Upload
        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (file) {
                loadRefAudio(file);
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                loadRefAudio(file);
            }
        }

        function loadRefAudio(file) {
            console.log('loadRefAudio called with file:', file.name);
            uploadedAudioFile = file;
            
            // åˆ›å»ºéŸ³é¢‘å¯¹è±¡
            const audioUrl = URL.createObjectURL(file);
            if (refAudioPlayer) {
                refAudioPlayer.pause();
                refAudioPlayer = null;
            }
            refAudioPlayer = new Audio(audioUrl);
            
            // è®¾ç½®éŸ³é¢‘äº‹ä»¶ç›‘å¬
            refAudioPlayer.ontimeupdate = updateRefAudioProgress;
            refAudioPlayer.onloadedmetadata = function() {
                console.log('Audio metadata loaded, duration:', refAudioPlayer.duration);
                document.getElementById('ref-total-time').textContent = formatTime(refAudioPlayer.duration);
                document.getElementById('ref-audio-duration').textContent = 'â±ï¸ æ—¶é•¿: ' + formatTime(refAudioPlayer.duration);
            };
            refAudioPlayer.onended = function() {
                isRefAudioPlaying = false;
                document.getElementById('ref-play-icon').style.display = 'block';
                document.getElementById('ref-pause-icon').style.display = 'none';
                document.getElementById('ref-progress-bar').style.width = '0%';
            };
            
            // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
            console.log('Showing audio player...');
            const uploadArea = document.getElementById('upload-area');
            const audioPlayer = document.getElementById('ref-audio-player');
            
            if (uploadArea) {
                uploadArea.style.display = 'none';
                console.log('Upload area hidden');
            } else {
                console.error('upload-area element not found!');
            }
            
            if (audioPlayer) {
                audioPlayer.style.display = 'block';
                console.log('Audio player shown');
            } else {
                console.error('ref-audio-player element not found!');
            }
            
            document.getElementById('ref-filename-display').textContent = file.name;
            
            // æ˜¾ç¤ºéŸ³é¢‘ä¿¡æ¯
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            document.getElementById('ref-audio-size').textContent = 'ğŸ“¦ å¤§å°: ' + fileSize + ' MB';
            document.getElementById('ref-audio-format').textContent = 'ğŸµ æ ¼å¼: ' + file.name.split('.').pop().toUpperCase();
            
            showToast('success', 'éŸ³é¢‘ä¸Šä¼ æˆåŠŸ', file.name);
        }

        function toggleRefAudioPlay() {
            if (!refAudioPlayer) return;
            
            const playIcon = document.getElementById('ref-play-icon');
            const pauseIcon = document.getElementById('ref-pause-icon');
            
            if (refAudioPlayer.paused) {
                refAudioPlayer.play();
                isRefAudioPlaying = true;
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                refAudioPlayer.pause();
                isRefAudioPlaying = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }

        function updateRefAudioProgress() {
            if (!refAudioPlayer || !refAudioPlayer.duration) return;
            
            const progress = (refAudioPlayer.currentTime / refAudioPlayer.duration) * 100;
            document.getElementById('ref-progress-bar').style.width = progress + '%';
            document.getElementById('ref-current-time').textContent = formatTime(refAudioPlayer.currentTime);
        }

        function seekRefAudio(event) {
            if (!refAudioPlayer || !refAudioPlayer.duration) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const clickPosition = (event.clientX - rect.left) / rect.width;
            refAudioPlayer.currentTime = clickPosition * refAudioPlayer.duration;
        }

        function removeRefAudio() {
            if (refAudioPlayer) {
                refAudioPlayer.pause();
                refAudioPlayer = null;
            }
            uploadedAudioFile = null;
            
            // é‡ç½®UI
            document.getElementById('upload-area').style.display = 'block';
            document.getElementById('ref-audio-player').style.display = 'none';
            document.getElementById('vc-audio').value = '';
            
            // é‡ç½®æ’­æ”¾çŠ¶æ€
            isRefAudioPlaying = false;
            document.getElementById('ref-play-icon').style.display = 'block';
            document.getElementById('ref-pause-icon').style.display = 'none';
            document.getElementById('ref-progress-bar').style.width = '0%';
            document.getElementById('ref-current-time').textContent = '0:00';
            document.getElementById('ref-total-time').textContent = '0:00';
        }

        // Model Selection Info
        const modelInfo = {
            'voice-design': {
                '1.7b': 'å®Œæ•´ç‰ˆï¼šæœ€é«˜è´¨é‡ï¼Œé€‚åˆå¯¹éŸ³è´¨è¦æ±‚é«˜çš„åœºæ™¯',
                '0.6b': 'è½»é‡ç‰ˆï¼šé€Ÿåº¦æå‡3å€ï¼Œé€‚åˆå¿«é€Ÿç”Ÿæˆå’Œæµ‹è¯•',
                'fast': 'âš¡ æé€Ÿæ¨¡å¼ï¼šæœ€å¿«ç”Ÿæˆé€Ÿåº¦ï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆå’Œæµ‹è¯•'
            },
            'voice-clone': {
                '1.7b': 'å®Œæ•´ç‰ˆï¼šæœ€ä½³å…‹éš†æ•ˆæœï¼Œä¿ç•™æ›´å¤šå£°éŸ³ç»†èŠ‚',
                '0.6b': 'è½»é‡ç‰ˆï¼šé€Ÿåº¦æå‡3å€ï¼Œé€‚åˆå®æ—¶å…‹éš†åœºæ™¯',
                'fast': 'âš¡ æé€Ÿæ¨¡å¼ï¼šæœ€å¿«ç”Ÿæˆé€Ÿåº¦ï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆå’Œæµ‹è¯•'
            },
            'tts-custom': {
                '1.7b': 'å®Œæ•´ç‰ˆï¼šæœ€é«˜è´¨é‡è¯­éŸ³åˆæˆï¼Œé€‚åˆä¸“ä¸šåœºæ™¯',
                '0.6b': 'è½»é‡ç‰ˆï¼šé€Ÿåº¦æå‡3å€ï¼Œé€‚åˆå¯¹è¯å’Œå®æ—¶åœºæ™¯',
                'fast': 'âš¡ æé€Ÿæ¨¡å¼ï¼šæœ€å¿«ç”Ÿæˆé€Ÿåº¦ï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆå’Œæµ‹è¯•'
            }
        };
        
        function updateModelInfo(mode) {
            const selectId = mode === 'voice-design' ? 'vd-model' : 
                            mode === 'voice-clone' ? 'vc-model' : 'tc-model';
            const infoId = mode === 'voice-design' ? 'vd-model-info' : 
                          mode === 'voice-clone' ? 'vc-model-info' : 'tc-model-info';
            
            const selectedModel = document.getElementById(selectId).value;
            document.getElementById(infoId).textContent = modelInfo[mode][selectedModel];
        }

        // Generate Functions
        async function generateVoiceDesign() {
            const text = document.getElementById('vd-text').value;
            const language = document.getElementById('vd-language').value;
            const description = document.getElementById('vd-description').value;
            const modelVersion = document.getElementById('vd-model').value;
            
            // è·å–æ¨¡å‹å‚æ•°
            const temperature = document.getElementById('temperature').value;
            const topP = document.getElementById('top-p').value;
            
            if (!text.trim()) {
                showToast('error', 'è¯·è¾“å…¥æ–‡æœ¬å†…å®¹');
                return;
            }
            
            await generateSpeech({
                mode: 'voice-design',
                text: text,
                language: language,
                voice_description: description,
                model_version: modelVersion,
                temperature: parseFloat(temperature),
                top_p: parseFloat(topP)
            }, 'vd-generate');
        }

        async function generateVoiceClone() {
            const targetText = document.getElementById('vc-target-text').value;
            const language = document.getElementById('vc-language').value;
            const modelVersion = document.getElementById('vc-model').value;
            const referenceText = document.getElementById('vc-reference-text').value;
            
            if (!targetText.trim()) {
                showToast('error', 'è¯·è¾“å…¥ç›®æ ‡æ–‡æœ¬');
                return;
            }
            
            if (!uploadedAudioFile) {
                showToast('error', 'è¯·å…ˆä¸Šä¼ å‚è€ƒéŸ³é¢‘');
                return;
            }
            
            const btn = document.getElementById('vc-generate');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            
            // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span> ä¸Šä¼ éŸ³é¢‘...';
            loadingText.textContent = 'æ­£åœ¨ä¸Šä¼ å‚è€ƒéŸ³é¢‘...';
            loadingOverlay.classList.add('show');
            
            try {
                // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                const formData = new FormData();
                formData.append('file', uploadedAudioFile);
                
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (!uploadData.success) {
                    throw new Error(uploadData.error || 'éŸ³é¢‘ä¸Šä¼ å¤±è´¥');
                }
                
                console.log('éŸ³é¢‘ä¸Šä¼ æˆåŠŸ:', uploadData.filename);
                
                // ç¬¬äºŒæ­¥ï¼šç”Ÿæˆè¯­éŸ³
                loadingText.textContent = 'æ­£åœ¨è¿›è¡Œå£°éŸ³å…‹éš†...';
                
                // è·å–æ¨¡å‹å‚æ•°
                const temperature = document.getElementById('temperature').value;
                const topP = document.getElementById('top-p').value;
                
                await generateSpeech({
                    mode: 'voice-clone',
                    text: targetText,
                    language: language,
                    reference_audio: uploadData.filename,
                    reference_text: referenceText,
                    model_version: modelVersion,
                    temperature: parseFloat(temperature),
                    top_p: parseFloat(topP)
                }, 'vc-generate');
                
            } catch (error) {
                showToast('error', 'å£°éŸ³å…‹éš†å¤±è´¥', error.message);
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ­</span> å…‹éš†å£°éŸ³';
                loadingOverlay.classList.remove('show');
            }
        }

        async function generateTTSCustom() {
            const text = document.getElementById('tc-text').value;
            const speaker = document.getElementById('tc-speaker').value;
            const language = document.getElementById('tc-language').value;
            const speed = document.getElementById('tc-speed').value;
            const style = document.getElementById('tc-style').value;
            const modelVersion = document.getElementById('tc-model').value;
            
            // è·å–æ¨¡å‹å‚æ•°
            const temperature = document.getElementById('temperature').value;
            const topP = document.getElementById('top-p').value;
            
            if (!text.trim()) {
                showToast('error', 'è¯·è¾“å…¥æ–‡æœ¬å†…å®¹');
                return;
            }
            
            await generateSpeech({
                mode: 'tts-custom',
                text: text,
                language: language,
                speaker: speaker,
                speed: speed,
                style: style,
                model_version: modelVersion,
                temperature: parseFloat(temperature),
                top_p: parseFloat(topP)
            }, 'tc-generate');
        }

        async function generateSpeech(params, btnId) {
            const btn = document.getElementById(btnId);
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const startTime = Date.now();
            
            // æ ¹æ®æ¨¡å¼è®¾ç½®ä¸åŒçš„æç¤ºæ–‡å­—
            const modeTexts = {
                'voice-design': 'æ­£åœ¨è®¾è®¡å£°éŸ³...',
                'voice-clone': 'æ­£åœ¨è¿›è¡Œå£°éŸ³å…‹éš†...',
                'tts-custom': 'æ­£åœ¨ç”Ÿæˆè¯­éŸ³...'
            };
            const loadingMessage = modeTexts[params.mode] || 'æ­£åœ¨ç”Ÿæˆ...';
            
            // UI Updates
            btn.disabled = true;
            btn.classList.add('generating');
            btn.innerHTML = '<span>â³</span> ç”Ÿæˆä¸­...';
            loadingOverlay.classList.add('show');
            loadingText.textContent = loadingMessage;
            statusIndicator.className = 'status-indicator processing';
            statusText.textContent = loadingMessage;
            
            try {
                const response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                    currentAudioUrl = data.audio_url;
                    
                    // Load audio
                    const audioPlayer = document.getElementById('audio-player');
                    audioPlayer.src = data.audio_url;
                    
                    // Update UI
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = 'ç”Ÿæˆå®Œæˆ';
                    document.getElementById('generation-info').textContent = `è€—æ—¶: ${duration}s`;
                    
                    // Add to history
                    addToHistory(params, duration);
                    
                    showToast('success', 'è¯­éŸ³ç”ŸæˆæˆåŠŸ', `è€—æ—¶ ${duration} ç§’`);
                } else {
                    throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator error';
                statusText.textContent = 'ç”Ÿæˆå¤±è´¥: ' + error.message;
                showToast('error', 'ç”Ÿæˆå¤±è´¥', error.message);
            } finally {
                btn.disabled = false;
                btn.classList.remove('generating');
                btn.innerHTML = btnId === 'vd-generate' ? '<span>ğŸ¨</span> ç”Ÿæˆå£°éŸ³' : 
                               btnId === 'vc-generate' ? '<span>ğŸ­</span> å…‹éš†å£°éŸ³' : 
                               '<span>ğŸ”Š</span> ç”Ÿæˆè¯­éŸ³';
                loadingOverlay.classList.remove('show');
            }
        }

        // Audio Controls
        function togglePlay() {
            const audioPlayer = document.getElementById('audio-player');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            
            if (!currentAudioUrl) {
                showToast('error', 'è¯·å…ˆç”Ÿæˆè¯­éŸ³');
                return;
            }
            
            if (audioPlayer.paused) {
                audioPlayer.play();
                isPlaying = true;
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                animateVisualizer(true);
            } else {
                audioPlayer.pause();
                isPlaying = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                animateVisualizer(false);
            }
        }

        function toggleMute() {
            const audioPlayer = document.getElementById('audio-player');
            const muteIcon = document.getElementById('mute-icon');
            const muteText = document.getElementById('mute-text');
            
            audioPlayer.muted = !audioPlayer.muted;
            isMuted = audioPlayer.muted;
            
            muteIcon.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            muteText.textContent = isMuted ? 'é™éŸ³' : 'éŸ³é‡';
        }

        function updateProgress() {
            const audioPlayer = document.getElementById('audio-player');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            
            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.width = progress + '%';
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                
                if (audioPlayer.ended) {
                    isPlaying = false;
                    document.getElementById('play-icon').style.display = 'block';
                    document.getElementById('pause-icon').style.display = 'none';
                    animateVisualizer(false);
                }
            }
        }

        function updateAudioInfo() {
            const audioPlayer = document.getElementById('audio-player');
            document.getElementById('total-time').textContent = formatTime(audioPlayer.duration);
        }

        function seekAudio(event) {
            const audioPlayer = document.getElementById('audio-player');
            if (!audioPlayer.duration) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const clickPosition = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = clickPosition * audioPlayer.duration;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function setPlaybackSpeed() {
            const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
            const audioPlayer = document.getElementById('audio-player');
            const currentSpeed = audioPlayer.playbackRate;
            const nextSpeed = speeds[(speeds.indexOf(currentSpeed) + 1) % speeds.length];
            audioPlayer.playbackRate = nextSpeed;
            showToast('success', 'æ’­æ”¾é€Ÿåº¦', nextSpeed + 'x');
        }

        function loopAudio() {
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.loop = !audioPlayer.loop;
            showToast('success', audioPlayer.loop ? 'å·²å¼€å¯å¾ªç¯æ’­æ”¾' : 'å·²å…³é—­å¾ªç¯æ’­æ”¾');
        }

        // History
        function addToHistory(params, duration) {
            const item = {
                mode: params.mode,
                text: params.text.substring(0, 50) + (params.text.length > 50 ? '...' : ''),
                duration: duration,
                time: new Date().toLocaleTimeString()
            };
            historyItems.unshift(item);
            updateHistoryList();
        }

        function updateHistoryList() {
            const container = document.getElementById('history-list');
            if (historyItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“­</div>
                        <div style="font-size: 13px;">æš‚æ— å†å²è®°å½•</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            historyItems.forEach((item, index) => {
                const modeNames = {
                    'voice-design': 'å£°éŸ³è®¾è®¡',
                    'voice-clone': 'å£°éŸ³å…‹éš†',
                    'tts-custom': 'é¢„è®¾å£°éŸ³'
                };
                
                const div = document.createElement('div');
                div.className = 'history-item';
                div.onclick = () => loadHistoryItem(index);
                div.innerHTML = `
                    <div class="history-header">
                        <span class="history-mode">${modeNames[item.mode]}</span>
                        <span class="history-time">${item.time}</span>
                    </div>
                    <div class="history-text">${item.text}</div>
                    <div class="history-meta">
                        <span>â±ï¸ ${item.duration}s</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function loadHistoryItem(index) {
            showToast('success', 'å·²åŠ è½½å†å²è®°å½• #' + (index + 1));
        }

        function clearHistory() {
            historyItems = [];
            updateHistoryList();
            showToast('success', 'å†å²è®°å½•å·²æ¸…ç©º');
        }

        // Settings
        function loadSettings() {
            // Temperature slider
            document.getElementById('temperature').addEventListener('input', function() {
                document.getElementById('temperature-value').textContent = this.value;
            });
            
            // Top P slider
            document.getElementById('top-p').addEventListener('input', function() {
                document.getElementById('top-p-value').textContent = this.value;
            });
            
            // Speed slider
            document.getElementById('tc-speed').addEventListener('input', function() {
                document.getElementById('tc-speed-value').textContent = this.value + 'x';
            });
        }

        // Actions
        function downloadAudio() {
            if (!currentAudioUrl) {
                showToast('error', 'è¯·å…ˆç”Ÿæˆè¯­éŸ³');
                return;
            }
            
            const a = document.createElement('a');
            a.href = currentAudioUrl;
            a.download = 'qwen-tts-' + Date.now() + '.wav';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('success', 'éŸ³é¢‘ä¸‹è½½å·²å¼€å§‹');
        }

        function shareAudio() {
            if (!currentAudioUrl) {
                showToast('error', 'è¯·å…ˆç”Ÿæˆè¯­éŸ³');
                return;
            }
            showToast('success', 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        function exportAudio() {
            showToast('success', 'éŸ³é¢‘å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­');
        }

        // Toast
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('.toast-icon');
            const titleEl = document.getElementById('toast-title');
            const messageEl = document.getElementById('toast-message');
            
            icon.className = 'toast-icon ' + type;
            icon.textContent = type === 'success' ? 'âœ“' : 'âœ—';
            titleEl.textContent = title;
            messageEl.textContent = message || '';
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
